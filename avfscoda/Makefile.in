SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
sbindir = @sbindir@
top_srcdir = @top_srcdir@

i_sbindir = $(install_root)$(sbindir)

CC = @CC@
CFLAGS = -I$(top_srcdir)/include -DCODAINCLUDE=\"@KERNINCLUDE@/linux/coda.h\" @CFLAGS@ @CPPFLAGS@
LDFLAGS = @LDFLAGS@ @LIBS@

INSTALL = @INSTALL@

all: all-@avfscoda_build@
install: install-@avfscoda_build@
depend: depend-@avfscoda_build@

all-no:
install-no:
depend-no:

all-yes: avfscoda
	$(MAKE) -C redir all

#leak=leak.o

ifeq (@shared_build@,yes)
  lib = ../lib/avfs.so.0.0.0
else
  lib = ../lib/avfs.o
endif

avfscoda_objs = \
	avfscoda.o           \
	mount.o              \
	dispatch.o           \
	child.o              \
	$(lib)               \
	$(leak)

avfscoda: $(avfscoda_objs)
	$(CC) -o avfscoda $(avfscoda_objs) $(LDFLAGS)

install-yes:
	@../mkinstalldirs $(i_sbindir)
	$(INSTALL) -m 755 avfscoda $(i_sbindir)/avfscoda
	$(MAKE) -C redir install

depend-yes:
	cp -f Makefile Makefile.old
	sed '/^# DO NOT REMOVE THIS LINE/q' < Makefile.old > Makefile
	gcc -MM $(CFLAGS) *.c >> Makefile

# DO NOT REMOVE THIS LINE, OR "make depend" WILL NOT WORK
