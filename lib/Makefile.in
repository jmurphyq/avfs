SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@
moduledir = @moduledir@

#TODO: include neon in build, and do this autoconfishly
DAV_INCLUDES = -I/usr/local/include/neon

i_libdir = $(install_root)$(libdir)

include modules.def

CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@ -I../include -DAV_VER=$(interface_version) -D_REENTRANT -D_POSIX_PTHREAD_SEMANTICS $(DAV_INCLUDES)
LD = @LD@

LDCONFIG = @LDCONFIG@
INSTALL = @INSTALL@

core_objs =								  \
      utils.o sysdeps.o tmpfile.o alloc.o parsels.o ugid.o parse.o prog.o \
      cache.o filebuf.o local.o default.o oper.o fdops.o virtual.o        \
      modload.o remote.o namespace.o state.o serialfile.o filtprog.o      \
      filter.o filecache.o socket.o passwords.o # dav_ls.o 

avfs_objs = $(core_objs) zlib/zlib.o modules/modules.o mod_static.o

all: libavfs.a

libavfs.a: $(avfs_objs)
	$(AR) cr libavfs.a $(avfs_objs)

mod_static.c: modules.def
	../make_initmod $(module_objs) > mod_static.c

utils.o: info.h

info.h:
	rm -f info.h
	./make_info $(moduledir) > info.h

zlib/zlib.o: FORCE
	$(MAKE) -C zlib zlib.o

modules/modules.o: FORCE
	$(MAKE) -C modules modules.o

install: libavfs.a
	@../mkinstalldirs $(i_libdir)
	$(INSTALL) -m 644 libavfs.a $(i_libdir)/libavfs.a

FORCE:

depend: info.h
	$(MAKE) -C zlib depend
	$(MAKE) -C modules depend
	cp -f Makefile Makefile.old
	sed '/^# DO NOT REMOVE THIS LINE/q' < Makefile.old > Makefile
	gcc -MM $(CPPFLAGS) *.c >> Makefile


# DO NOT REMOVE THIS LINE, OR "make depend" WILL NOT WORK
