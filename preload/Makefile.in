SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@
serverdir = @moduledir@
top_srcdir = @top_srcdir@

i_libdir = $(install_root)$(libdir)
i_serverdir = $(install_root)$(serverdir)

CC = @CC@
CFLAGS = -I$(top_srcdir)/include @CFLAGS@ -fPIC @CPPFLAGS@ \
	-DAVFS_SERVER_DIR=\"$(serverdir)\"
LDFLAGS = @LDFLAGS@ @LIBS@
PRELOAD_LIBS = @PRELOAD_LIBS@

INSTALL = @INSTALL@

all: all-@preload_build@
install: install-@preload_build@
depend: depend-@preload_build@

all-no:
install-no:
depend-no:

all-yes: avfs_server avfs_preload.so

#leak=leak.o

ifeq (@shared_build@,yes)
  lib = ../lib/avfs.so.0.0.0
else
  lib = ../lib/avfs.o
endif

avfs_server_objs = \
	avfs_server.o       \
	server.o            \
	send.o              \
	$(lib)              \
	$(leak)

avfs_server: $(avfs_server_objs)
	$(CC) -o avfs_server $(avfs_server_objs) $(LDFLAGS)

avfs_preload_objs = \
	client.o  \
	utils.o   \
	send.o    \
	file.o    \
	open.o    \
	stat.o    \
	misc.o

avfs_preload.so: $(avfs_preload_objs)
	$(CC) -shared -o avfs_preload.so $(avfs_preload_objs) $(PRELOAD_LIBS)

install-yes:
	rm -f $(i_serverdir)/avfs_server
	$(INSTALL) -m 755 avfs_server $(i_serverdir)/avfs_server
	rm -f $(i_libdir)/avfs_preload.so
	$(INSTALL) -m 755 avfs_preload.so $(i_libdir)/avfs_preload.so

depend-yes:
	cp -f Makefile Makefile.old
	sed '/^# DO NOT REMOVE THIS LINE/q' < Makefile.old > Makefile
	gcc -MM $(CFLAGS) *.c >> Makefile

# DO NOT REMOVE THIS LINE, OR "make depend" WILL NOT WORK
