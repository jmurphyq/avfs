SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
sbindir = @sbindir@
top_srcdir = @top_srcdir@

i_sbindir = $(install_root)$(sbindir)

CC = @CC@
CFLAGS = -I$(top_srcdir)/include @CFLAGS@ -fPIC @CPPFLAGS@
LDFLAGS = @LDFLAGS@ @LIBS@

all: all-@preload_build@
install: install-@preload_build@
depend: depend-@preload_build@

all-no:
install-no:
depend-no:

all-yes: avfs_server avfs_preload.so

#leak=leak.o

avfs_server_objs = \
	avfs_server.o          \
	server.o               \
	send.o                 \
	../src/libavfs.a        \
	../modules/libmodules.a \
	../src/libavfs.a        \
	$(leak)

avfs_server: $(avfs_server_objs)
	$(CC) -o avfs_server $(avfs_server_objs) $(LDFLAGS)

avfs_preload_objs = \
	client.o  \
	utils.o   \
	send.o    \
	file.o    \
	open.o    \
	stat.o

avfs_preload.so: $(avfs_preload_objs)
	$(CC) -shared -o avfs_preload.so $(avfs_preload_objs) -lsocket

depend-yes:
	cp -f Makefile Makefile.old
	sed '/^# DO NOT REMOVE THIS LINE/q' < Makefile.old > Makefile
	gcc -MM $(CFLAGS) *.c >> Makefile

# DO NOT REMOVE THIS LINE, OR "make depend" WILL NOT WORK
